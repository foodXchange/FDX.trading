@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using FoodX.Supplier.Models
@using FoodX.Admin.Data
@using FoodX.Admin.Models
@using MudBlazor
@attribute [Authorize(Policy = "SupplierOnly")]
@inject UserManager<FoodX.Supplier.Models.ApplicationUser> UserManager
@inject FoodXDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar

<PageTitle>Company Profile - FoodX Supplier Portal</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Company Profile</MudText>
<MudText Typo="Typo.body1" Color="Color.Tertiary" Class="mb-6">
    Manage your company information and keep your profile up to date
</MudText>

@if (isLoading)
{
    <MudProgressLinear Indeterminate="true" />
}
else if (supplierProfile == null)
{
    <MudAlert Severity="Severity.Warning">
        No supplier profile found. Please complete your profile setup.
        <MudButton Href="/profile/setup" Color="Color.Primary" Variant="Variant.Text">Complete Setup</MudButton>
    </MudAlert>
}
else
{
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <!-- Basic Information Tab -->
        <MudTabPanel Text="Basic Information" Icon="@Icons.Material.Filled.Business">
            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudPaper Class="pa-4" Elevation="0">
                        <EditForm Model="@supplierProfile" OnValidSubmit="SaveBasicInfo">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudTextField Label="Company Name" 
                                                  @bind-Value="supplierProfile.SupplierName" 
                                                  Variant="Variant.Outlined"
                                                  Required="true" />
                                </MudItem>
                                
                                <MudItem xs="12">
                                    <MudTextField Label="Description" 
                                                  @bind-Value="supplierProfile.Description" 
                                                  Variant="Variant.Outlined"
                                                  Lines="4"
                                                  HelperText="Describe your company and products" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="Country" 
                                                  @bind-Value="supplierProfile.Country" 
                                                  Variant="Variant.Outlined"
                                                  Required="true" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="City" 
                                                  @bind-Value="supplierProfile.City" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                
                                <MudItem xs="12">
                                    <MudTextField Label="Full Address" 
                                                  @bind-Value="supplierProfile.Address" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="Company Email" 
                                                  @bind-Value="supplierProfile.CompanyEmail" 
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Email" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="Company Website" 
                                                  @bind-Value="supplierProfile.CompanyWebsite" 
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Url" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="Phone" 
                                                  @bind-Value="supplierProfile.Phone" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudTextField Label="WhatsApp" 
                                                  @bind-Value="supplierProfile.Whatsapp" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                
                                <MudItem xs="12">
                                    <MudButton ButtonType="ButtonType.Submit" 
                                               Variant="Variant.Filled" 
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               Disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        }
                                        Save Basic Information
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </EditForm>
                    </MudPaper>
                </MudItem>
                
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4" Elevation="0">
                        <MudText Typo="Typo.h6" Class="mb-4">Profile Completion</MudText>
                        <MudProgressLinear Value="@profileCompleteness" Color="@(profileCompleteness >= 80 ? Color.Success : Color.Warning)" Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="Color.Tertiary">@profileCompleteness% Complete</MudText>
                        
                        <MudList T="string" Dense="true" Class="mt-4">
                            <MudListItem T="string" Icon="@(HasBasicInfo() ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)" 
                                         IconColor="@(HasBasicInfo() ? Color.Success : Color.Default)">
                                Basic Information
                            </MudListItem>
                            <MudListItem T="string" Icon="@(HasContactInfo() ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)"
                                         IconColor="@(HasContactInfo() ? Color.Success : Color.Default)">
                                Contact Details
                            </MudListItem>
                            <MudListItem T="string" Icon="@(HasBusinessInfo() ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)"
                                         IconColor="@(HasBusinessInfo() ? Color.Success : Color.Default)">
                                Business Information
                            </MudListItem>
                            <MudListItem T="string" Icon="@(HasCertifications() ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)"
                                         IconColor="@(HasCertifications() ? Color.Success : Color.Default)">
                                Certifications
                            </MudListItem>
                        </MudList>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        
        <!-- Business Details Tab -->
        <MudTabPanel Text="Business Details" Icon="@Icons.Material.Filled.BusinessCenter">
            <MudPaper Class="pa-4" Elevation="0">
                <EditForm Model="@supplierProfile" OnValidSubmit="SaveBusinessInfo">
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Product Category" 
                                          @bind-Value="supplierProfile.ProductCategory" 
                                          Variant="Variant.Outlined"
                                          HelperText="Main product category" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Product Types" 
                                          @bind-Value="supplierProfile.ProductTypes" 
                                          Variant="Variant.Outlined"
                                          HelperText="Specific product types" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudTextField Label="Product Details" 
                                          @bind-Value="supplierProfile.ProductDetails" 
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          HelperText="Detailed description of your products" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Markets Served" 
                                          @bind-Value="supplierProfile.Markets" 
                                          Variant="Variant.Outlined"
                                          HelperText="Countries or regions you serve" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Export Percentage" 
                                          @bind-Value="supplierProfile.ExportPercentage" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Number"
                                          Adornment="Adornment.End"
                                          AdornmentText="%"
                                          HelperText="Percentage of production exported" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Number of Employees" 
                                          @bind-Value="supplierProfile.NumberOfEmployees" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Number" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Year Established" 
                                          @bind-Value="supplierProfile.YearFounded" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Number"
                                          HelperText="Year company was founded" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Annual Revenue" 
                                          @bind-Value="supplierProfile.AnnualRevenue" 
                                          Variant="Variant.Outlined"
                                          HelperText="e.g., €1M - €5M" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Production Capacity" 
                                          @bind-Value="supplierProfile.ProductionCapacity" 
                                          Variant="Variant.Outlined"
                                          HelperText="e.g., 1000 tons/year" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudButton ButtonType="ButtonType.Submit" 
                                       Variant="Variant.Filled" 
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Save Business Details
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudPaper>
        </MudTabPanel>
        
        <!-- Certifications Tab -->
        <MudTabPanel Text="Certifications" Icon="@Icons.Material.Filled.VerifiedUser">
            <MudPaper Class="pa-4" Elevation="0">
                <MudText Typo="Typo.h6" Class="mb-4">Quality & Compliance Certifications</MudText>
                
                <EditForm Model="@supplierProfile" OnValidSubmit="SaveCertifications">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox @bind-Value="supplierProfile.IsKosherCertified" 
                                         Color="Color.Primary">
                                Kosher Certified
                            </MudCheckBox>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox @bind-Value="supplierProfile.IsHalalCertified" 
                                         Color="Color.Primary">
                                Halal Certified
                            </MudCheckBox>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox @bind-Value="supplierProfile.IsOrganicCertified" 
                                         Color="Color.Primary">
                                Organic Certified
                            </MudCheckBox>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="3">
                            <MudCheckBox @bind-Value="supplierProfile.IsGlutenFreeCertified" 
                                         Color="Color.Primary">
                                Gluten-Free Certified
                            </MudCheckBox>
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudTextField Label="Other Certifications" 
                                          @bind-Value="supplierProfile.Certifications" 
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          HelperText="List any additional certifications (ISO, HACCP, BRC, etc.)" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudButton ButtonType="ButtonType.Submit" 
                                       Variant="Variant.Filled" 
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Save Certifications
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </EditForm>
                
                <MudDivider Class="my-4" />
                
                <MudText Typo="Typo.h6" Class="mb-4">Upload Certification Documents</MudText>
                <MudText Typo="Typo.body2" Color="Color.Tertiary" Class="mb-4">
                    Upload PDF or image files of your certification documents
                </MudText>
                
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.CloudUpload"
                           OnClick="@(() => { /* TODO: Implement file upload */ })">
                    Upload Documents
                </MudButton>
            </MudPaper>
        </MudTabPanel>
        
        <!-- Social Media Tab -->
        <MudTabPanel Text="Social Media" Icon="@Icons.Material.Filled.Share">
            <MudPaper Class="pa-4" Elevation="0">
                <EditForm Model="@supplierProfile" OnValidSubmit="SaveSocialMedia">
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="LinkedIn" 
                                          @bind-Value="supplierProfile.LinkedInUrl" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Url"
                                          AdornmentIcon="@Icons.Custom.Brands.LinkedIn"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Facebook" 
                                          @bind-Value="supplierProfile.FacebookUrl" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Url"
                                          AdornmentIcon="@Icons.Custom.Brands.Facebook"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Twitter/X" 
                                          @bind-Value="supplierProfile.TwitterUrl" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Url"
                                          AdornmentIcon="@Icons.Custom.Brands.Twitter"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Instagram" 
                                          @bind-Value="supplierProfile.InstagramUrl" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Url"
                                          AdornmentIcon="@Icons.Material.Filled.PhotoCamera"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudTextField Label="YouTube Channel" 
                                          @bind-Value="supplierProfile.YouTubeUrl" 
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Url"
                                          AdornmentIcon="@Icons.Custom.Brands.YouTube"
                                          Adornment="Adornment.Start" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudButton ButtonType="ButtonType.Submit" 
                                       Variant="Variant.Filled" 
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Save Social Media Links
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
}

@code {
    private SupplierProfile? supplierProfile;
    private FoodX.Supplier.Models.ApplicationUser? currentUser;
    private bool isLoading = true;
    private bool isSaving = false;
    private int profileCompleteness = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadSupplierProfile();
    }
    
    private async Task LoadSupplierProfile()
    {
        isLoading = true;
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUser = await UserManager.GetUserAsync(authState.User);
            
            if (currentUser?.FoodXSupplierId != null)
            {
                var dbSupplier = await DbContext.FoodXSuppliers
                    .FirstOrDefaultAsync(s => s.Id == currentUser.FoodXSupplierId);
                
                if (dbSupplier != null)
                {
                    // Map to SupplierProfile
                    supplierProfile = new SupplierProfile();
                    // Copy all properties from FoodXSupplier
                    foreach (var prop in typeof(FoodXSupplier).GetProperties())
                    {
                        var value = prop.GetValue(dbSupplier);
                        prop.SetValue(supplierProfile, value);
                    }
                }
                else
                {
                    // Create new profile
                    supplierProfile = new SupplierProfile
                    {
                        SupplierName = currentUser.CompanyName ?? string.Empty,
                        Country = currentUser.Country,
                        CompanyEmail = currentUser.Email,
                        Phone = currentUser.PhoneNumber,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow
                    };
                }
            }
            
            CalculateProfileCompleteness();
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void CalculateProfileCompleteness()
    {
        if (supplierProfile == null)
        {
            profileCompleteness = 0;
            return;
        }
        
        int completed = 0;
        int total = 4;
        
        if (HasBasicInfo()) completed++;
        if (HasContactInfo()) completed++;
        if (HasBusinessInfo()) completed++;
        if (HasCertifications()) completed++;
        
        profileCompleteness = (completed * 100) / total;
    }
    
    private bool HasBasicInfo()
    {
        return supplierProfile != null && 
               !string.IsNullOrWhiteSpace(supplierProfile.SupplierName) &&
               !string.IsNullOrWhiteSpace(supplierProfile.Country);
    }
    
    private bool HasContactInfo()
    {
        return supplierProfile != null && 
               (!string.IsNullOrWhiteSpace(supplierProfile.CompanyEmail) ||
                !string.IsNullOrWhiteSpace(supplierProfile.Phone));
    }
    
    private bool HasBusinessInfo()
    {
        return supplierProfile != null && 
               !string.IsNullOrWhiteSpace(supplierProfile.ProductCategory);
    }
    
    private bool HasCertifications()
    {
        return supplierProfile != null && 
               (supplierProfile.IsKosherCertified == true ||
                supplierProfile.IsHalalCertified == true ||
                supplierProfile.IsOrganicCertified == true ||
                supplierProfile.IsGlutenFreeCertified == true ||
                !string.IsNullOrWhiteSpace(supplierProfile.Certifications));
    }
    
    private async Task SaveBasicInfo()
    {
        await SaveProfile("Basic information saved successfully");
    }
    
    private async Task SaveBusinessInfo()
    {
        await SaveProfile("Business details saved successfully");
    }
    
    private async Task SaveCertifications()
    {
        await SaveProfile("Certifications saved successfully");
    }
    
    private async Task SaveSocialMedia()
    {
        await SaveProfile("Social media links saved successfully");
    }
    
    private async Task SaveProfile(string successMessage)
    {
        if (supplierProfile == null) return;
        
        isSaving = true;
        
        try
        {
            supplierProfile.UpdatedAt = DateTime.UtcNow;
            
            // Map back to FoodXSupplier for saving
            FoodXSupplier dbSupplier;
            if (supplierProfile.Id == 0)
            {
                dbSupplier = new FoodXSupplier();
                DbContext.FoodXSuppliers.Add(dbSupplier);
            }
            else
            {
                dbSupplier = await DbContext.FoodXSuppliers.FindAsync(supplierProfile.Id) ?? new FoodXSupplier();
            }
            
            // Copy properties from SupplierProfile to FoodXSupplier
            foreach (var prop in typeof(FoodXSupplier).GetProperties())
            {
                if (prop.CanWrite)
                {
                    var value = prop.GetValue(supplierProfile);
                    prop.SetValue(dbSupplier, value);
                }
            }
            
            await DbContext.SaveChangesAsync();
            
            // Update user profile completion status
            if (currentUser != null && profileCompleteness >= 80 && !currentUser.ProfileCompleted)
            {
                currentUser.ProfileCompleted = true;
                currentUser.ProfileCompletedAt = DateTime.UtcNow;
                await UserManager.UpdateAsync(currentUser);
            }
            
            CalculateProfileCompleteness();
            Snackbar.Add(successMessage, Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }
}