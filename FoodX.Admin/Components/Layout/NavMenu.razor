@implements IDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using FoodX.Admin.Services

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IRoleNavigationService RoleNavigationService

<MudNavMenu>
    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="@_dashboardUrl" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            
            <!-- Common Business Features -->
            <MudNavGroup Title="Business" Icon="@Icons.Material.Filled.Business" Expanded="true">
                <MudNavLink Href="companies" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Business">
                    Companies
                </MudNavLink>
                <MudNavLink Href="products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category">
                    Products
                </MudNavLink>
                <MudNavLink Href="suppliers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocalShipping">
                    Suppliers
                </MudNavLink>
                <MudNavLink Href="supplier-database" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Storage">
                    Supplier Database
                </MudNavLink>
                <MudNavLink Href="buyers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ShoppingCart">
                    Buyers
                </MudNavLink>
                <MudNavLink Href="request-analysis" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Psychology">
                    AI Request Analysis
                </MudNavLink>
            </MudNavGroup>
            
            <!-- SuperAdmin Only -->
            <AuthorizeView Roles="SuperAdmin" Context="superAdminContext">
                <MudNavGroup Title="SuperAdmin" Icon="@Icons.Material.Filled.SupervisorAccount" Expanded="false">
                    <MudNavLink Href="superadmin/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SpaceDashboard">
                        Unified Dashboard
                    </MudNavLink>
                    <MudNavLink Href="superadmin/impersonate" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.PersonSearch">
                        User Impersonation
                    </MudNavLink>
                    <MudNavLink Href="superadmin/portal-management" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewModule">
                        Portal Management
                    </MudNavLink>
                    <MudNavLink Href="superadmin/analytics" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.QueryStats">
                        Cross-Portal Analytics
                    </MudNavLink>
                    <MudNavLink Href="superadmin/audit-log" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History">
                        Audit Log
                    </MudNavLink>
                    <MudNavLink Href="superadmin/system-health" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.MonitorHeart">
                        System Health
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>
            
            <!-- Admin Only -->
            <AuthorizeView Roles="Admin,SuperAdmin" Context="adminContext">
                <MudNavGroup Title="Administration" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false">
                    <MudNavLink Href="users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">
                        Users
                    </MudNavLink>
                    <MudNavLink Href="buyer-companies" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Store">
                        Buyer Companies Database
                    </MudNavLink>
                    <MudNavLink Href="settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">
                        Settings
                    </MudNavLink>
                    <MudNavLink Href="vector-search" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Search">
                        Vector Search
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>
            
            <!-- Role-Specific Features -->
            <AuthorizeView Roles="Buyer" Context="buyerContext">
                <MudNavGroup Title="Procurement" Icon="@Icons.Material.Filled.ShoppingCart" Expanded="false">
                    <MudNavLink Href="quotes/request" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.RequestQuote">
                        Request Quotes
                    </MudNavLink>
                    <MudNavLink Href="orders" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Receipt">
                        My Orders
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>
            
            <AuthorizeView Roles="Supplier,Seller" Context="supplierContext">
                <MudNavGroup Title="Sales" Icon="@Icons.Material.Filled.Sell" Expanded="false">
                    <MudNavLink Href="inventory" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory">
                        Inventory
                    </MudNavLink>
                    <MudNavLink Href="quotes/respond" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Reply">
                        Quote Requests
                    </MudNavLink>
                </MudNavGroup>
            </AuthorizeView>
            
            <!-- My Account -->
            <MudDivider Class="my-2" />
            
            <MudNavLink Href="user-details" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountCircle">
                My Profile
            </MudNavLink>
            
            <MudNavLink Href="companies/my-company" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Store">
                My Company
            </MudNavLink>
            
            <MudNavLink Href="Account/Manage" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">
                Account Settings
            </MudNavLink>
            
            <MudDivider Class="my-2" />
            
            <form action="Account/Logout" method="post">
                <AntiforgeryToken />
                <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                <button type="submit" class="mud-nav-link mud-ripple">
                    <MudIcon Icon="@Icons.Material.Filled.Logout" Color="Color.Error" Class="mr-3"></MudIcon>
                    Sign Out
                </button>
            </form>
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                Home
            </MudNavLink>
            <MudNavLink Href="Account/MagicLink" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login">
                Sign In
            </MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private string? currentUrl;
    private string _dashboardUrl = "/";
    private List<string> _userRoles = new();

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        
        // Get user roles and dashboard URL
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            _userRoles = await RoleNavigationService.GetUserRoles(authState.User);
            _dashboardUrl = await RoleNavigationService.GetRoleBasedDashboardUrl(authState.User);
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}