@using FoodX.Admin.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IPortalContextService PortalContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudNavMenu>
    <!-- Primary Actions - Always visible -->
    <MudNavLink Href="/" Icon="@Icons.Material.Filled.Dashboard" Match="NavLinkMatch.All">
        <MudText Typo="Typo.subtitle2" Class="font-weight-bold">Dashboard</MudText>
    </MudNavLink>

    @if (PortalContext.CurrentMode == PortalMode.Buyer || PortalContext.CurrentMode == PortalMode.Admin)
    {
        <!-- Procurement Section -->
        <MudNavGroup Title="Procurement" Icon="@Icons.Material.Filled.ShoppingCart" Expanded="true">
            <MudNavLink Href="/portal/buyer/ai-search" Icon="@Icons.Material.Filled.Search">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText>Find Products</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="pa-1">AI</MudChip>
                </MudStack>
            </MudNavLink>
            <MudNavLink Href="/portal/buyer/rfqs" Icon="@Icons.Material.Filled.RequestQuote">
                <MudText>My RFQs</MudText>
            </MudNavLink>
            <MudNavLink Href="/portal/buyer/quotes" Icon="@Icons.Material.Filled.Receipt">
                <MudText>Received Quotes</MudText>
            </MudNavLink>
            <MudNavLink Href="/portal/buyer/orders" Icon="@Icons.Material.Filled.ShoppingBag">
                <MudText>Purchase Orders</MudText>
            </MudNavLink>
        </MudNavGroup>
    }

    @if (PortalContext.CurrentMode == PortalMode.Supplier || PortalContext.CurrentMode == PortalMode.Admin)
    {
        <!-- Supply Section -->
        <MudNavGroup Title="Supply" Icon="@Icons.Material.Filled.LocalShipping" Expanded="false">
            <MudNavLink Href="/portal/supplier/products" Icon="@Icons.Material.Filled.Inventory">
                Products
            </MudNavLink>
            <MudNavLink Href="/portal/supplier/rfqs" Icon="@Icons.Material.Filled.RequestQuote">
                RFQ Requests
            </MudNavLink>
            <MudNavLink Href="/portal/supplier/orders" Icon="@Icons.Material.Filled.ShoppingBag">
                Orders
            </MudNavLink>
        </MudNavGroup>
    }

    <!-- Browse/Search - All users -->
    <MudNavGroup Title="Browse" Icon="@Icons.Material.Filled.Search" Expanded="false">
        @if (PortalContext.CurrentMode == PortalMode.Buyer || PortalContext.CurrentMode == PortalMode.Admin)
        {
            <MudNavLink Href="/suppliers" Icon="@Icons.Material.Filled.Store">
                Suppliers
            </MudNavLink>
        }
        @if (PortalContext.CurrentMode == PortalMode.Supplier || PortalContext.CurrentMode == PortalMode.Admin)
        {
            <MudNavLink Href="/buyers" Icon="@Icons.Material.Filled.Business">
                Buyers
            </MudNavLink>
        }
        <MudNavLink Href="/products" Icon="@Icons.Material.Filled.Category">
            Products
        </MudNavLink>
        <MudNavLink Href="/portal/buyer/ai-search" Icon="@Icons.Material.Filled.Psychology">
            AI Search
        </MudNavLink>
    </MudNavGroup>

    <!-- Analytics - Based on role -->
    <MudNavLink Href="/analytics" Icon="@Icons.Material.Filled.Analytics">
        Analytics
    </MudNavLink>

    <!-- Email & Communication -->
    <MudNavGroup Title="Communication" Icon="@Icons.Material.Filled.Email" Expanded="false">
        <MudNavLink Href="/support/email/inbox" Icon="@Icons.Material.Filled.Inbox">
            Inbox
        </MudNavLink>
        <MudNavLink Href="/support/email/compose" Icon="@Icons.Material.Filled.Create">
            Compose
        </MudNavLink>
        <MudNavLink Href="/support/email/sent" Icon="@Icons.Material.Filled.Send">
            Sent Mail
        </MudNavLink>
    </MudNavGroup>

    <!-- Admin Section - Only for Admin/SuperAdmin -->
    <AuthorizeView Roles="Admin,SuperAdmin">
        <MudDivider Class="my-2" />
        <MudNavGroup Title="Admin" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false">
            <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">
                Users
            </MudNavLink>
            <MudNavLink Href="/companies" Icon="@Icons.Material.Filled.Business">
                Companies
            </MudNavLink>
            <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">
                Settings
            </MudNavLink>
        </MudNavGroup>
        
        <!-- Data Import Section -->
        <MudNavGroup Title="Data Import" Icon="@Icons.Material.Filled.FileUpload" Expanded="false">
            <MudNavLink Href="/admin/import/suppliers" Icon="@Icons.Material.Filled.Store">
                Import Suppliers
            </MudNavLink>
            <MudNavLink Href="/admin/import/buyers" Icon="@Icons.Material.Filled.Business">
                Import Buyers
            </MudNavLink>
            <MudNavLink Href="/portal/supplier/products/import" Icon="@Icons.Material.Filled.Category">
                Import Products
            </MudNavLink>
        </MudNavGroup>
    </AuthorizeView>

    <!-- SuperAdmin Section -->
    <AuthorizeView Roles="SuperAdmin">
        <MudNavGroup Title="SuperAdmin" Icon="@Icons.Material.Filled.Security" Expanded="false">
            <MudNavLink Href="/superadmin/dashboard" Icon="@Icons.Material.Filled.Dashboard">
                System Overview
            </MudNavLink>
            <MudNavLink Href="/superadmin/impersonate" Icon="@Icons.Material.Filled.PersonSearch">
                Impersonate User
            </MudNavLink>
        </MudNavGroup>
    </AuthorizeView>

    <!-- Help & Support -->
    <MudDivider Class="my-2" />
    <MudNavGroup Title="Help & Support" Icon="@Icons.Material.Filled.Help" Expanded="false">
        <MudNavLink Href="/support/email/inbox-preview" Icon="@Icons.Material.Filled.Email">
            Email Inbox
        </MudNavLink>
        <MudNavLink Href="/help" Icon="@Icons.Material.Filled.HelpOutline">
            Help Center
        </MudNavLink>
        <MudNavLink Href="/support/report-issue" Icon="@Icons.Material.Filled.BugReport">
            Report Issue
        </MudNavLink>
    </MudNavGroup>
</MudNavMenu>

@code {
    protected override Task OnInitializedAsync()
    {
        // Subscribe to portal mode changes
        PortalContext.PortalModeChanged += OnPortalModeChanged;
        return Task.CompletedTask;
    }

    private void OnPortalModeChanged(object? sender, PortalMode mode)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        PortalContext.PortalModeChanged -= OnPortalModeChanged;
    }
}