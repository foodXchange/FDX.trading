@page "/portal/buyer/quotes"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@attribute [Authorize(Roles = "SuperAdmin,Admin,Buyer")]
@rendermode InteractiveServer

<PageTitle>Quotes - FoodX Buyer Portal</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h4" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                Quotes Management
            </MudText>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Received Quotes</MudText>
                
                <MudTable Items="@_quotes" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Quote #</MudTh>
                        <MudTh>Supplier</MudTh>
                        <MudTh>Product</MudTh>
                        <MudTh>Price</MudTh>
                        <MudTh>Valid Until</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Id</MudTd>
                        <MudTd>@context.Supplier</MudTd>
                        <MudTd>@context.Product</MudTd>
                        <MudTd>â‚¬@context.Price.ToString("N2")</MudTd>
                        <MudTd>@context.ValidUntil.ToString("MMM dd")</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" @onclick="() => ViewQuote(context)">View</MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Success" @onclick="() => AcceptQuote(context)">Accept</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private IDialogService Dialog { get; set; } = null!;
    
    private List<QuoteItem> _quotes = new();
    
    protected override void OnInitialized()
    {
        _quotes = new List<QuoteItem>
        {
            new QuoteItem { Id = "Q-2024-101", Supplier = "Italian Farms", Product = "Organic Tomatoes", Price = 2.50m, ValidUntil = DateTime.Now.AddDays(5), Status = "New" },
            new QuoteItem { Id = "Q-2024-102", Supplier = "Dutch Dairy", Product = "Fresh Mozzarella", Price = 8.90m, ValidUntil = DateTime.Now.AddDays(3), Status = "Pending" },
            new QuoteItem { Id = "Q-2024-103", Supplier = "Spanish Oils", Product = "Olive Oil", Price = 4.20m, ValidUntil = DateTime.Now.AddDays(7), Status = "Reviewed" },
        };
    }
    
    private async Task ViewQuote(QuoteItem quote)
    {
        var parameters = new DialogParameters<QuoteDetailsDialog>
        {
            { x => x.Quote, quote }
        };
        
        var dialog = await Dialog.ShowAsync<QuoteDetailsDialog>($"Quote {quote.Id}", parameters);
    }
    
    private async Task AcceptQuote(QuoteItem quote)
    {
        var result = await Dialog.ShowMessageBox(
            "Accept Quote",
            $"Are you sure you want to accept quote {quote.Id} from {quote.Supplier}?",
            yesText: "Accept", cancelText: "Cancel");
            
        if (result == true)
        {
            quote.Status = "Accepted";
            Snackbar.Add($"Quote {quote.Id} has been accepted", Severity.Success);
            StateHasChanged();
        }
    }
    
    private Color GetStatusColor(string status) => status switch
    {
        "New" => Color.Warning,
        "Pending" => Color.Info,
        "Reviewed" => Color.Success,
        "Accepted" => Color.Success,
        "Rejected" => Color.Error,
        _ => Color.Default
    };
    
    public class QuoteItem
    {
        public string Id { get; set; } = "";
        public string Supplier { get; set; } = "";
        public string Product { get; set; } = "";
        public decimal Price { get; set; }
        public DateTime ValidUntil { get; set; }
        public string Status { get; set; } = "";
    }
}