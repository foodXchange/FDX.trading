@page "/portal/supplier/profile"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdmin,Admin,Supplier")]
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Company Profile - FoodX Supplier Portal</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h4" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
                Company Profile Management
            </MudText>
        </MudItem>

        <!-- Profile Summary Card -->
        <MudItem xs="12">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="2" Class="text-center">
                            <MudAvatar Size="Size.Large" Class="mx-auto mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" />
                            </MudAvatar>
                            <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary">
                                Upload Logo
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="10">
                            <MudText Typo="Typo.h5" Class="mb-2">@profileModel.CompanyName</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-1">@profileModel.BusinessType</MudText>
                            <MudText Typo="Typo.body2">@profileModel.Address, @profileModel.City, @profileModel.PostalCode</MudText>
                            
                            <div class="mt-3">
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="mr-2">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                    Verified Supplier
                                </MudChip>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                    <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-1" />
                                    Premium Member
                                </MudChip>
                            </div>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Tabs for Different Sections -->
        <MudItem xs="12">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                
                <!-- Basic Information Tab -->
                <MudTabPanel Text="Basic Information" Icon="@Icons.Material.Filled.Info">
                    <EditForm Model="@profileModel" OnValidSubmit="SaveBasicInfo">
                        <DataAnnotationsValidator />
                        
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.CompanyName" 
                                            Label="Company Name" 
                                            Required="true"
                                            For="@(() => profileModel.CompanyName)" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="profileModel.BusinessType" Label="Business Type" Required="true">
                                    <MudSelectItem Value="@("Farm/Producer")">Farm/Producer</MudSelectItem>
                                    <MudSelectItem Value="@("Distributor")">Distributor</MudSelectItem>
                                    <MudSelectItem Value="@("Wholesaler")">Wholesaler</MudSelectItem>
                                    <MudSelectItem Value="@("Manufacturer")">Manufacturer</MudSelectItem>
                                    <MudSelectItem Value="@("Processor")">Processor</MudSelectItem>
                                    <MudSelectItem Value="@("Importer/Exporter")">Importer/Exporter</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField @bind-Value="profileModel.Description" 
                                            Label="Company Description" 
                                            Lines="4"
                                            For="@(() => profileModel.Description)" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.VATNumber" 
                                            Label="VAT Number" 
                                            For="@(() => profileModel.VATNumber)" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.RegistrationNumber" 
                                            Label="Registration Number" 
                                            For="@(() => profileModel.RegistrationNumber)" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="profileModel.YearEstablished" 
                                               Label="Year Established" 
                                               Min="1900" 
                                               Max="@DateTime.Now.Year" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="profileModel.NumberOfEmployees" 
                                               Label="Number of Employees" 
                                               Min="1" />
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-4">
                                <MudButton ButtonType="ButtonType.Submit"
                                         Variant="Variant.Filled" 
                                         Color="Color.Primary"
                                         StartIcon="@Icons.Material.Filled.Save"
                                         Disabled="@_isSaving">
                                    @if (_isSaving)
                                    {
                                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                                        <MudText Class="ms-2">Saving...</MudText>
                                    }
                                    else
                                    {
                                        <MudText>Save Changes</MudText>
                                    }
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                </MudTabPanel>

                <!-- Contact Information Tab -->
                <MudTabPanel Text="Contact Information" Icon="@Icons.Material.Filled.ContactPhone">
                    <EditForm Model="@profileModel" OnValidSubmit="SaveContactInfo">
                        <DataAnnotationsValidator />
                        
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.h6" Class="mb-4">Primary Contact</MudText>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.ContactPersonName" 
                                            Label="Contact Person Name" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.ContactTitle" 
                                            Label="Title/Position" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Email" 
                                            Label="Email Address" 
                                            InputType="InputType.Email"
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Phone" 
                                            Label="Phone Number" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Mobile" 
                                            Label="Mobile Number" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Fax" 
                                            Label="Fax Number" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudDivider Class="my-4" />
                                <MudText Typo="Typo.h6" Class="mb-4">Business Address</MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField @bind-Value="profileModel.Address" 
                                            Label="Street Address" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.City" 
                                            Label="City" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.PostalCode" 
                                            Label="Postal Code" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Country" 
                                            Label="Country" 
                                            Required="true" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.Website" 
                                            Label="Website URL" 
                                            InputType="InputType.Url" />
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-4">
                                <MudButton ButtonType="ButtonType.Submit"
                                         Variant="Variant.Filled" 
                                         Color="Color.Primary"
                                         StartIcon="@Icons.Material.Filled.Save"
                                         Disabled="@_isSaving">
                                    Save Contact Information
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                </MudTabPanel>

                <!-- Business Categories Tab -->
                <MudTabPanel Text="Business Categories" Icon="@Icons.Material.Filled.Category">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-4">Product Categories</MudText>
                            <MudText Typo="Typo.body2" Class="mb-4">Select the categories that best describe your business offerings:</MudText>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Dairy" Label="Dairy Products" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Meat" Label="Meat & Poultry" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Seafood" Label="Seafood" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Vegetables" Label="Fresh Vegetables" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Fruits" Label="Fresh Fruits" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Grains" Label="Grains & Cereals" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Beverages" Label="Beverages" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Spices" Label="Spices & Herbs" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Oils" Label="Oils & Condiments" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Bakery" Label="Bakery Products" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Frozen" Label="Frozen Foods" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Categories.Organic" Label="Organic Products" />
                        </MudItem>
                        
                        <MudItem xs="12" Class="mt-4">
                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary"
                                     StartIcon="@Icons.Material.Filled.Save"
                                     OnClick="SaveCategories">
                                Save Categories
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Certifications Tab -->
                <MudTabPanel Text="Certifications" Icon="@Icons.Material.Filled.Verified">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-4">Quality Certifications</MudText>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.ISO9001" Label="ISO 9001:2015" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.ISO22000" Label="ISO 22000" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.HACCP" Label="HACCP" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.BRC" Label="BRC Global Standards" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.IFS" Label="IFS Food Standard" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.EUOrganic" Label="EU Organic" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.Halal" Label="Halal Certification" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.Kosher" Label="Kosher Certification" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.FairTrade" Label="Fair Trade" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudCheckBox @bind-Value="profileModel.Certifications.GlobalGAP" Label="GlobalG.A.P." />
                        </MudItem>
                        
                        <MudItem xs="12" Class="mt-4">
                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary"
                                     StartIcon="@Icons.Material.Filled.Save"
                                     OnClick="SaveCertifications">
                                Save Certifications
                            </MudButton>
                        </MudItem>
                        
                        <MudItem xs="12" Class="mt-6">
                            <MudText Typo="Typo.h6" Class="mb-4">Upload Certificate Documents</MudText>
                            <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".pdf,.jpg,.png" FilesChanged="OnCertificateFilesChanged" MaximumFileCount="10">
                                <ActivatorContent>
                                    <MudButton HtmlTag="label"
                                             Variant="Variant.Outlined"
                                             Color="Color.Primary"
                                             StartIcon="@Icons.Material.Filled.CloudUpload">
                                        Upload Certificates
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            
                            @if (_certificateFiles.Any())
                            {
                                <MudList T="string" Class="mt-3">
                                    @foreach (var file in _certificateFiles)
                                    {
                                        <MudListItem T="string" Text="@($"{file.Name} ({file.Size / 1024}KB)")" />
                                    }
                                </MudList>
                            }
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Payment & Banking Tab -->
                <MudTabPanel Text="Payment & Banking" Icon="@Icons.Material.Filled.AccountBalance">
                    <EditForm Model="@profileModel.PaymentInfo" OnValidSubmit="SavePaymentInfo">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.h6" Class="mb-4">Banking Information</MudText>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.PaymentInfo.BankName" 
                                            Label="Bank Name" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.PaymentInfo.AccountHolderName" 
                                            Label="Account Holder Name" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.PaymentInfo.IBAN" 
                                            Label="IBAN" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profileModel.PaymentInfo.SWIFT" 
                                            Label="SWIFT/BIC Code" />
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudDivider Class="my-4" />
                                <MudText Typo="Typo.h6" Class="mb-4">Payment Terms</MudText>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="profileModel.PaymentInfo.PaymentTerms" Label="Default Payment Terms">
                                    <MudSelectItem Value="@("Cash on Delivery")">Cash on Delivery</MudSelectItem>
                                    <MudSelectItem Value="@("Net 15")">Net 15 Days</MudSelectItem>
                                    <MudSelectItem Value="@("Net 30")">Net 30 Days</MudSelectItem>
                                    <MudSelectItem Value="@("Net 45")">Net 45 Days</MudSelectItem>
                                    <MudSelectItem Value="@("Net 60")">Net 60 Days</MudSelectItem>
                                    <MudSelectItem Value="@("Prepayment")">Prepayment Required</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="profileModel.PaymentInfo.MinimumOrderAmount" 
                                               Label="Minimum Order Amount (â‚¬)" 
                                               Format="N2" />
                            </MudItem>
                            
                            <MudItem xs="12" Class="mt-4">
                                <MudButton ButtonType="ButtonType.Submit"
                                         Variant="Variant.Filled" 
                                         Color="Color.Primary"
                                         StartIcon="@Icons.Material.Filled.Save">
                                    Save Payment Information
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                </MudTabPanel>
            </MudTabs>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool _isSaving = false;
    private List<IBrowserFile> _certificateFiles = new();
    private SupplierProfileModel profileModel = new();

    protected override void OnInitialized()
    {
        LoadProfileData();
    }

    private void LoadProfileData()
    {
        // Mock data - in real implementation, load from database
        profileModel = new SupplierProfileModel
        {
            CompanyName = "Premium Food Suppliers BV",
            BusinessType = "Distributor",
            Description = "We are a leading distributor of premium food products, specializing in organic and sustainable food items for the Belgian market.",
            VATNumber = "BE0123456789",
            RegistrationNumber = "0123.456.789",
            YearEstablished = 1995,
            NumberOfEmployees = 45,
            ContactPersonName = "Jan Vandenberghe",
            ContactTitle = "Sales Manager",
            Email = "jan.vandenberghe@premiumfood.be",
            Phone = "+32 2 123 4567",
            Mobile = "+32 476 12 34 56",
            Fax = "+32 2 123 4568",
            Address = "Industrielaan 123",
            City = "Brussels",
            PostalCode = "1000",
            Country = "Belgium",
            Website = "https://www.premiumfood.be",
            Categories = new CategoryModel
            {
                Dairy = true,
                Meat = true,
                Vegetables = true,
                Fruits = true,
                Organic = true
            },
            Certifications = new CertificationModel
            {
                ISO9001 = true,
                HACCP = true,
                EUOrganic = true,
                BRC = true
            },
            PaymentInfo = new PaymentInfoModel
            {
                BankName = "KBC Bank",
                AccountHolderName = "Premium Food Suppliers BV",
                IBAN = "BE12 3456 7890 1234",
                SWIFT = "KREDBEBB",
                PaymentTerms = "Net 30",
                MinimumOrderAmount = 250.00m
            }
        };
    }

    private async Task SaveBasicInfo()
    {
        _isSaving = true;
        try
        {
            await Task.Delay(1500); // Simulate API call
            Snackbar.Add("Basic information saved successfully!");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving information: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task SaveContactInfo()
    {
        await Task.Delay(1000);
        Snackbar.Add("Contact information saved successfully!");
    }

    private async Task SaveCategories()
    {
        await Task.Delay(1000);
        Snackbar.Add("Business categories saved successfully!");
    }

    private async Task SaveCertifications()
    {
        await Task.Delay(1000);
        Snackbar.Add("Certifications saved successfully!");
    }

    private async Task SavePaymentInfo()
    {
        await Task.Delay(1000);
        Snackbar.Add("Payment information saved successfully!");
    }

    private void OnCertificateFilesChanged(IReadOnlyList<IBrowserFile> files)
    {
        _certificateFiles = files.ToList();
    }

    public class SupplierProfileModel
    {
        // Basic Information
        public string CompanyName { get; set; } = "";
        public string BusinessType { get; set; } = "";
        public string Description { get; set; } = "";
        public string VATNumber { get; set; } = "";
        public string RegistrationNumber { get; set; } = "";
        public int YearEstablished { get; set; }
        public int NumberOfEmployees { get; set; }
        
        // Contact Information
        public string ContactPersonName { get; set; } = "";
        public string ContactTitle { get; set; } = "";
        public string Email { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Mobile { get; set; } = "";
        public string Fax { get; set; } = "";
        public string Address { get; set; } = "";
        public string City { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Country { get; set; } = "";
        public string Website { get; set; } = "";
        
        // Categories and Certifications
        public CategoryModel Categories { get; set; } = new();
        public CertificationModel Certifications { get; set; } = new();
        public PaymentInfoModel PaymentInfo { get; set; } = new();
    }

    public class CategoryModel
    {
        public bool Dairy { get; set; }
        public bool Meat { get; set; }
        public bool Seafood { get; set; }
        public bool Vegetables { get; set; }
        public bool Fruits { get; set; }
        public bool Grains { get; set; }
        public bool Beverages { get; set; }
        public bool Spices { get; set; }
        public bool Oils { get; set; }
        public bool Bakery { get; set; }
        public bool Frozen { get; set; }
        public bool Organic { get; set; }
    }

    public class CertificationModel
    {
        public bool ISO9001 { get; set; }
        public bool ISO22000 { get; set; }
        public bool HACCP { get; set; }
        public bool BRC { get; set; }
        public bool IFS { get; set; }
        public bool EUOrganic { get; set; }
        public bool Halal { get; set; }
        public bool Kosher { get; set; }
        public bool FairTrade { get; set; }
        public bool GlobalGAP { get; set; }
    }

    public class PaymentInfoModel
    {
        public string BankName { get; set; } = "";
        public string AccountHolderName { get; set; } = "";
        public string IBAN { get; set; } = "";
        public string SWIFT { get; set; } = "";
        public string PaymentTerms { get; set; } = "";
        public decimal MinimumOrderAmount { get; set; }
    }
}