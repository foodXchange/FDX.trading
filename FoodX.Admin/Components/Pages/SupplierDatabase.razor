@page "/supplier-database"
@using FoodX.Admin.Data
@using FoodX.Admin.Models
@using Microsoft.EntityFrameworkCore
@using System.Timers
@inject FoodXDbContext DbContext
@inject ISnackbar Snackbar
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Supplier Database</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h3" Class="mb-2">Global Supplier Database</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                Browse and search @totalSuppliers.ToString("N0") imported suppliers with product information
            </MudText>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="searchTerm" 
                              Label="Search suppliers, products, or categories" 
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              @onkeyup="@(async (KeyboardEventArgs e) => { if (e.Key == "Enter") await SearchSuppliers(); else OnSearchTextChanged(); })"
                              Immediate="true" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect @bind-Value="selectedCountry" Label="Country" Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@("")">All Countries</MudSelectItem>
                    @foreach (var country in topCountries)
                    {
                        <MudSelectItem Value="@country">@country</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect @bind-Value="selectedCategory" Label="Category" Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@("")">All Categories</MudSelectItem>
                    @foreach (var category in topCategories)
                    {
                        <MudSelectItem Value="@category">@category</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudCheckBox @bind-Value="showOnlyWithProducts" Label="Has Products" Color="Color.Primary" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           FullWidth="true"
                           OnClick="SearchSuppliers"
                           StartIcon="@Icons.Material.Filled.FilterList">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-3">
            <MudItem xs="12" md="3">
                <MudCheckBox @bind-Value="filterKosher" Label="Kosher Products" Color="Color.Success" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCheckBox @bind-Value="filterHalal" Label="Halal Products" Color="Color.Success" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCheckBox @bind-Value="filterOrganic" Label="Organic Products" Color="Color.Success" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCheckBox @bind-Value="filterGlutenFree" Label="Gluten-Free Products" Color="Color.Success" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading && !suppliers.Any())
    {
        <!-- Skeleton loaders for initial load -->
        <MudGrid>
            @for (int i = 0; i < 12; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="h-100">
                        <MudCardHeader Class="pb-2">
                            <MudSkeleton Width="80%" Height="20px" />
                            <MudSkeleton Width="50%" Height="15px" Class="mt-2" />
                        </MudCardHeader>
                        <MudCardContent>
                            <MudSkeleton Width="60%" Height="15px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="40px" Class="mb-2" />
                            <MudSkeleton Width="70%" Height="15px" />
                        </MudCardContent>
                        <MudCardActions>
                            <MudSkeleton Width="80px" Height="30px" Class="mr-2" />
                            <MudSkeleton Width="80px" Height="30px" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (suppliers.Any())
    {
        <MudPaper Class="mb-3 pa-3">
            <MudText Typo="Typo.body2">
                Found <strong>@totalFilteredSuppliers.ToString("N0")</strong> suppliers 
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <text>matching "@searchTerm"</text>
                }
                @if (suppliers.Count < totalFilteredSuppliers)
                {
                    <text> (showing @suppliers.Count)</text>
                }
            </MudText>
        </MudPaper>

        <MudGrid>
            @foreach (var supplier in suppliers)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="h-100 supplier-card" Style="transition: all 0.3s ease; cursor: pointer;">
                        <MudCardHeader Class="pb-2" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <CardHeaderContent>
                                <MudTooltip Text="@supplier.SupplierName">
                                    <MudText Typo="Typo.h6" Class="text-truncate" Style="font-size: 1rem; font-weight: 500;">
                                        @supplier.SupplierName
                                    </MudText>
                                </MudTooltip>
                                @if (!string.IsNullOrEmpty(supplier.Country))
                                {
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" /> @supplier.Country
                                    </MudText>
                                }
                            </CardHeaderContent>
                            <CardHeaderAvatar>
                                @if (!string.IsNullOrEmpty(supplier.Country) && supplier.Country.Length >= 2)
                                {
                                    <MudAvatar Size="Size.Small" Style="background-color: rgba(255,255,255,0.2);">
                                        <MudText Typo="Typo.caption">@supplier.Country.Substring(0, Math.Min(2, supplier.Country.Length)).ToUpper()</MudText>
                                    </MudAvatar>
                                }
                            </CardHeaderAvatar>
                        </MudCardHeader>
                        <MudCardContent Class="pt-2 pb-2" Style="min-height: 120px;">
                            @if (!string.IsNullOrEmpty(supplier.ProductCategory))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined" Class="mb-2">
                                    @supplier.ProductCategory
                                </MudChip>
                            }
                            
                            @if (!string.IsNullOrEmpty(supplier.Products))
                            {
                                var products = supplier.Products.Split(new[] { ';', ',' }, StringSplitOptions.RemoveEmptyEntries)
                                    .Where(p => !string.IsNullOrWhiteSpace(p))
                                    .Take(2)
                                    .ToList();
                                
                                <div class="mb-1">
                                    @foreach (var product in products)
                                    {
                                        var trimmedProduct = product.Trim();
                                        <MudTooltip Text="@trimmedProduct">
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Surface" Class="pa-1 mb-1">
                                                @(trimmedProduct.Length > 25 ? trimmedProduct.Substring(0, 25) + "..." : trimmedProduct)
                                            </MudChip>
                                        </MudTooltip>
                                    }
                                </div>
                                
                                var totalProducts = supplier.Products.Split(new[] { ';', ',' }, StringSplitOptions.RemoveEmptyEntries).Length;
                                @if (totalProducts > 2)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 500;">
                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />@(totalProducts - 2) more products
                                    </MudText>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="font-italic">
                                    No products listed
                                </MudText>
                            }

                            @if (!string.IsNullOrEmpty(supplier.CompanyEmail))
                            {
                                <MudTooltip Text="@supplier.CompanyEmail">
                                    <MudText Typo="Typo.caption" Class="mt-2 text-truncate" Style="opacity: 0.8;">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> 
                                        @supplier.CompanyEmail
                                    </MudText>
                                </MudTooltip>
                            }
                        </MudCardContent>
                        <MudDivider />
                        <MudCardActions Class="justify-space-between">
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Info"
                                       OnClick="@(() => ViewSupplierDetails(supplier))">
                                Details
                            </MudButton>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Success" 
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Description"
                                       OnClick="@(() => CreateBrief(supplier))">
                                Brief
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @if (hasMore)
        {
            <MudPaper Class="mt-4 pa-3 text-center">
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Primary"
                           OnClick="LoadMore"
                           Disabled="@isLoading">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        <text>Loading...</text>
                    }
                    else
                    {
                        <text>Load More Suppliers</text>
                    }
                </MudButton>
            </MudPaper>
        }
        
        @if (isLoading && suppliers.Any())
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-2" />
        }
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            @if (string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(selectedCountry) && string.IsNullOrEmpty(selectedCategory))
            {
                <text>Click "Search" to browse suppliers or enter search criteria to find specific suppliers.</text>
            }
            else
            {
                <text>No suppliers found matching your criteria. Try adjusting your search filters.</text>
            }
        </MudAlert>
    }
</MudContainer>

@code {
    private List<FoodXSupplier> suppliers = new();
    private bool isLoading = false;
    private string searchTerm = "";
    private string selectedCountry = "";
    private string selectedCategory = "";
    private bool showOnlyWithProducts = false;
    private bool filterKosher = false;
    private bool filterHalal = false;
    private bool filterOrganic = false;
    private bool filterGlutenFree = false;
    private int totalSuppliers = 0;
    private int totalFilteredSuppliers = 0;
    private int currentPage = 0;
    private int pageSize = 24;
    private bool hasMore = false;
    private List<string> topCountries = new();
    private List<string> topCategories = new();
    private System.Timers.Timer? searchDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
        // Load initial suppliers automatically
        await LoadSuppliers();
    }

    private async Task LoadStatistics()
    {
        try
        {
            // Get total count
            totalSuppliers = await DbContext.FoodXSuppliers.CountAsync();

            // Get top countries
            topCountries = await DbContext.FoodXSuppliers
                .Where(s => !string.IsNullOrEmpty(s.Country))
                .GroupBy(s => s.Country!)
                .OrderByDescending(g => g.Count())
                .Take(20)
                .Select(g => g.Key)
                .ToListAsync();

            // Get top categories
            topCategories = await DbContext.FoodXSuppliers
                .Where(s => !string.IsNullOrEmpty(s.ProductCategory))
                .Select(s => s.ProductCategory!)
                .Distinct()
                .OrderBy(c => c)
                .Take(30)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading statistics: {ex.Message}", Severity.Error);
        }
    }

    private async Task SearchSuppliers()
    {
        currentPage = 0;
        suppliers.Clear();
        await LoadSuppliers();
    }

    private async Task LoadMore()
    {
        currentPage++;
        await LoadSuppliers(append: true);
    }

    private async Task LoadSuppliers(bool append = false)
    {
        isLoading = true;
        try
        {
            var query = DbContext.FoodXSuppliers.AsNoTracking();

            // Apply search filter using EF Core optimized queries
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                var term = searchTerm.Trim();
                // Use EF.Functions for better SQL generation
                query = query.Where(s => 
                    EF.Functions.Like(s.SupplierName, $"%{term}%") ||
                    (s.ProductCategory != null && EF.Functions.Like(s.ProductCategory, $"%{term}%")) ||
                    (s.Products != null && EF.Functions.Like(s.Products, $"%{term}%")) ||
                    (s.Description != null && EF.Functions.Like(s.Description, $"%{term}%")));
            }

            // Apply country filter
            if (!string.IsNullOrEmpty(selectedCountry))
            {
                query = query.Where(s => s.Country == selectedCountry);
            }

            // Apply category filter
            if (!string.IsNullOrEmpty(selectedCategory))
            {
                query = query.Where(s => s.ProductCategory == selectedCategory);
            }

            // Apply products filter
            if (showOnlyWithProducts)
            {
                query = query.Where(s => s.Products != null && s.Products != "");
            }

            // Apply certification filters using optimized boolean columns
            if (filterKosher)
            {
                query = query.Where(s => s.IsKosherCertified == true);
            }
            if (filterHalal)
            {
                query = query.Where(s => s.IsHalalCertified == true);
            }
            if (filterOrganic)
            {
                query = query.Where(s => s.IsOrganicCertified == true);
            }
            if (filterGlutenFree)
            {
                query = query.Where(s => s.IsGlutenFreeCertified == true);
            }

            // Get total count for pagination
            totalFilteredSuppliers = await query.CountAsync();
            hasMore = (currentPage + 1) * pageSize < totalFilteredSuppliers;

            // Apply pagination and get results with optimized projection
            var newSuppliers = await query
                .OrderBy(s => s.SupplierName)
                .Skip(currentPage * pageSize)
                .Take(pageSize)
                .Select(s => new FoodXSupplier
                {
                    Id = s.Id,
                    SupplierName = s.SupplierName,
                    Country = s.Country,
                    ProductCategory = s.ProductCategory,
                    Products = s.Products,
                    CompanyEmail = s.CompanyEmail,
                    Description = s.Description,
                    CompanyWebsite = s.CompanyWebsite,
                    Phone = s.Phone
                })
                .ToListAsync();

            if (append)
            {
                suppliers.AddRange(newSuppliers);
            }
            else
            {
                suppliers = newSuppliers;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading suppliers: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchTextChanged()
    {
        // Cancel any existing timer
        searchDebounceTimer?.Stop();
        searchDebounceTimer?.Dispose();

        // Create a new timer that will fire after 500ms of no typing
        searchDebounceTimer = new System.Timers.Timer(500);
        searchDebounceTimer.Elapsed += async (sender, e) =>
        {
            searchDebounceTimer?.Dispose();
            searchDebounceTimer = null;
            
            // Run search on UI thread
            await InvokeAsync(async () =>
            {
                await SearchSuppliers();
            });
        };
        searchDebounceTimer.AutoReset = false;
        searchDebounceTimer.Start();
    }

    private void ViewSupplierDetails(FoodXSupplier supplier)
    {
        // TODO: Implement supplier details view dialog
        Snackbar.Add($"View details for {supplier.SupplierName}", Severity.Info);
    }

    private void CreateBrief(FoodXSupplier supplier)
    {
        // TODO: Implement brief creation for supplier
        Snackbar.Add($"Create brief for {supplier.SupplierName}", Severity.Info);
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
    }
}